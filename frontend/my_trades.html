<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“¦ My Trade Requests - BookBuddy</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
</head>

<body class="container mt-5">
  <h2 class="mb-4">ğŸ“¦ My Trade Requests</h2>

  <div class="mb-5">
    <h4>â¡ï¸ Requests I Sent</h4>
    <div id="sentTrades" class="row g-3"></div>
  </div>

  <div>
    <h4>â¬…ï¸ Requests I Received</h4>
    <div id="receivedTrades" class="row g-3"></div>
  </div>

  <script>
  $(document).ready(function() {
    console.log("ğŸ“¦ My Trades page loaded.");

    function loadTrades() {
      $.ajax({
        url: "../backend/trade.php",
        type: "POST",
        data: { action: "get_trades" },
        dataType: "json",
        success: function(res) {
          console.log("âœ… Trade data:", res);
          if (res.status === "success") {
            renderTrades(res.sent, "#sentTrades", false);
            renderTrades(res.received, "#receivedTrades", true);
          } else {
            alert("âš ï¸ " + res.message);
          }
        },
        error: function(xhr) {
          console.error("âŒ Load error:", xhr.responseText);
        }
      });
    }

    function renderTrades(trades, containerId, canRespond) {
      const container = $(containerId);
      container.empty();

      if (trades.length === 0) {
        container.html('<p>No trades found.</p>');
        return;
      }

      trades.forEach(t => {
        const html = `
          <div class="col-md-5">
            <div class="card shadow-sm p-3">
              <h5>${t.book_title}</h5>
              <p><strong>Status:</strong> ${t.status}</p>
              <p><strong>From:</strong> ${t.requester_name}</p>
              <p><strong>To:</strong> ${t.owner_name}</p>
              ${canRespond && t.status === 'pending' ? `
                <button class="btn btn-success btn-sm me-2" onclick="respondTrade(${t.id}, 'accepted')">âœ… Accept</button>
                <button class="btn btn-danger btn-sm" onclick="respondTrade(${t.id}, 'rejected')">âŒ Reject</button>
              ` : ''}
            </div>
          </div>`;
        container.append(html);
      });
    }

    // Accept/Reject a trade
    window.respondTrade = function(tradeId, action) {
      $.ajax({
        url: "../backend/trade.php",
        type: "POST",
        data: { action: "respond_trade", trade_id: tradeId, response: action },
        dataType: "json",
        success: function(res) {
          alert(res.message);
          loadTrades();
        },
        error: function(xhr) {
          console.error("âŒ Response error:", xhr.responseText);
        }
      });
    };

    loadTrades();
  });
  </script>
</body>
</html>
